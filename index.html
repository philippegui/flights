<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <div class="container mx-auto p-4 md:p-8 max-w-3xl">
        <main class="pt-4">
            <!-- Flights List Container -->
            <div id="flights-list" class="space-y-6">
                <!-- Flight cards will be injected here by JavaScript -->
            </div>
        </main>
    </div>

    <script>
        // --- Configuration ---
        const apiKey = "3a8d9a3b3c3d41b5bbc814002e16c8fd";
        
        // Your upcoming flights with detailed schedule information, including airline IATA code for logos.
        const myFlights = [
            { 
                flightNumber: 'AC3106', flightDate: '2025-08-09', airline: 'United Airlines', airlineIata: 'UA',
                duration: '5h 29m',
                departure: { iata: 'SFO', airport: 'San Francisco Int\'l', time: '11:47 PM' }, 
                arrival: { iata: 'YUL', airport: 'Montréal-Trudeau', time: '8:16 AM' } 
            },
            { 
                flightNumber: 'AC878',  flightDate: '2025-08-10', airline: 'Air Canada', airlineIata: 'AC',
                duration: '6h 55m',
                departure: { iata: 'YUL', airport: 'Montréal-Trudeau', time: '7:30 PM' },
                arrival: { iata: 'TLS', airport: 'Toulouse-Blagnac', time: '8:25 AM' }
            },
            { 
                flightNumber: 'AC879',  flightDate: '2025-08-30', airline: 'Air Canada', airlineIata: 'AC',
                duration: '7h 40m',
                departure: { iata: 'TLS', airport: 'Toulouse-Blagnac', time: '10:00 AM' },
                arrival: { iata: 'YUL', airport: 'Montréal-Trudeau', time: '11:40 AM' }
            },
            { 
                flightNumber: 'AC763',  flightDate: '2025-08-30', airline: 'Air Canada', airlineIata: 'AC',
                duration: '6h 12m',
                departure: { iata: 'YUL', airport: 'Montréal-Trudeau', time: '4:45 PM' },
                arrival: { iata: 'SFO', airport: 'San Francisco Int\'l', time: '7:57 PM' }
            }
        ];

        // --- DOM Elements ---
        const flightsListContainer = document.getElementById('flights-list');

        // --- Core Functions ---
        async function fetchFlightData(flightIata, flightDate) {
            const originalApiUrl = `http://api.aviationstack.com/v1/flights?access_key=${apiKey}&flight_iata=${flightIata}`;
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(originalApiUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`CORS proxy request failed: ${response.status}`);
                
                const proxyData = await response.json();
                const apiData = JSON.parse(proxyData.contents);

                if (apiData.error) throw new Error(apiData.error.info || `API returned an error for ${flightIata}.`);
                if (apiData.data && apiData.data.length > 0) return apiData.data[0];
                
                throw new Error(`Live data for flight ${flightIata} not found.`);
            } catch (error) {
                console.error(`Error fetching ${flightIata}:`, error);
                return { error: true, flightIata, message: error.message };
            }
        }
        
        function createFlightCard(flight, statusInfo) {
            const isLiveData = statusInfo && !statusInfo.error;
            
            const airlineName = isLiveData ? statusInfo.airline.name : flight.airline;
            const airlineIata = isLiveData ? statusInfo.airline.iata : flight.airlineIata;
            const departure = isLiveData ? statusInfo.departure : flight.departure;
            const arrival = isLiveData ? statusInfo.arrival : flight.arrival;
            const flight_status = isLiveData ? (statusInfo.flight_status || 'scheduled') : 'scheduled';

            const formatTime = (dateString, timeZone) => {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: timeZone });
            };
            
            const formatHeaderDate = (dateString) => {
                const d = new Date(dateString + 'T00:00:00');
                return d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short', timeZone: 'UTC' }).toUpperCase().replace(/,/g, '');
            };

            const headerDate = formatHeaderDate(flight.flightDate);
            const departureTime = isLiveData ? formatTime(departure.scheduled, departure.timezone) : departure.time;
            const arrivalTime = isLiveData ? formatTime(arrival.scheduled, arrival.timezone) : arrival.time;
            
            const departureGate = isLiveData ? (statusInfo.departure.gate || '–') : '–';
            const arrivalGate = isLiveData ? (statusInfo.arrival.gate || '–') : '–';
            const departureTerminal = isLiveData ? (statusInfo.departure.terminal || '–') : '–';
            const arrivalTerminal = isLiveData ? (statusInfo.arrival.terminal || '–') : '–';
            
            let statusText = 'Scheduled';
            if (isLiveData) {
                statusText = flight_status.replace(/_/g, ' ');
            }

            return `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
                    <!-- Card Header -->
                    <div class="flex items-center px-4 py-3 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700">
                        <img src="https://images.kiwi.com/airlines/64/${airlineIata}.png" alt="${airlineName} logo" class="h-8 w-8 mr-3 rounded-md flex-shrink-0" onerror="this.style.display='none'">
                        <div>
                            <p class="text-sm font-bold text-gray-800 dark:text-gray-200">${flight.flightNumber} &bull; ${headerDate}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${flight.departure.iata} to ${flight.arrival.iata}</p>
                        </div>
                    </div>

                    <!-- Main Content: Departure, Connector, Arrival -->
                    <div class="px-4 pb-4 pt-4">
                        <!-- Departure -->
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${departure.iata} &bull; ${departure.airport}</p>
                                <p class="text-3xl font-bold text-gray-900 dark:text-white">${departureTime}</p>
                                <p class="text-xs text-green-600 dark:text-green-400 font-semibold capitalize">${statusText}</p>
                            </div>
                            <div class="text-right">
                                <div class="bg-yellow-400 rounded-lg px-3 py-1 flex items-center justify-center min-w-[50px]">
                                    <p class="text-xl font-bold text-yellow-900">${departureGate}</p>
                                </div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Terminal ${departureTerminal}</p>
                            </div>
                        </div>

                        <!-- Connector -->
                        <div class="flex items-center my-2">
                            <div class="flex-grow border-t-2 border-dotted border-gray-300 dark:border-gray-600"></div>
                            <span class="text-xs text-gray-500 dark:text-gray-400 px-2">${flight.duration}</span>
                            <div class="flex-grow border-t-2 border-dotted border-gray-300 dark:border-gray-600"></div>
                        </div>

                        <!-- Arrival -->
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${arrival.iata} &bull; ${arrival.airport}</p>
                                <p class="text-3xl font-bold text-gray-900 dark:text-white">${arrivalTime}</p>
                                <p class="text-xs text-green-600 dark:text-green-400 font-semibold capitalize">${statusText}</p>
                            </div>
                            <div class="text-right">
                                <div class="bg-yellow-400 rounded-lg px-3 py-1 flex items-center justify-center min-w-[50px]">
                                    <p class="text-xl font-bold text-yellow-900">${arrivalGate}</p>
                                </div>
                                 <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Terminal ${arrivalTerminal}</p>
                            </div>
                        </div>
                    </div>
                    ${!isLiveData ? `<div class="bg-gray-100 dark:bg-gray-700 px-5 py-2 text-[10px] text-center text-gray-500 dark:text-gray-400 rounded-b-xl">Live tracking will begin on the day of departure.</div>` : ''}
                </div>
            `;
        }

        function createErrorCard(flight, errorData) {
            const scheduledCard = createFlightCard(flight, null); // Show scheduled info
            const errorHtml = `
                <div class="mt-[-8px] rounded-b-xl bg-red-100 dark:bg-red-900/20 border-t-2 border-red-200 text-red-700 dark:text-red-300 p-2 text-[10px] text-center" role="alert">
                    <strong>Update Failed:</strong> ${errorData.message}
                </div>
            `;
            return scheduledCard.replace('</div>', `${errorHtml}</div>`);
        }

        async function loadMyTrips() {
            flightsListContainer.innerHTML = '<div class="my-12 flex justify-center"><div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div></div>';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const flightPromises = myFlights.map(async (flight) => {
                const flightDate = new Date(flight.flightDate + 'T00:00:00-08:00');
                flightDate.setHours(0, 0, 0, 0);

                if (flightDate.getTime() === today.getTime()) {
                    const liveData = await fetchFlightData(flight.flightNumber, flight.flightDate);
                    if (liveData.error) {
                        return createErrorCard(flight, liveData);
                    }
                    return createFlightCard(flight, liveData);
                } else {
                    return createFlightCard(flight, null);
                }
            });
            
            const flightCardsHtml = await Promise.all(flightPromises);
            flightsListContainer.innerHTML = flightCardsHtml.join('');
        }

        document.addEventListener('DOMContentLoaded', loadMyTrips);
    </script>
</body>
</html>
