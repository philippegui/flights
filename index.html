<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Upcoming Trips</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <div class="container mx-auto p-4 md:p-8 max-w-3xl">
        <main class="pt-8">
            <!-- Flights List Container -->
            <div id="flights-list" class="space-y-8">
                <!-- Flight cards will be injected here by JavaScript -->
            </div>
        </main>
    </div>

    <script>
        // --- Configuration ---
        const apiKey = "3a8d9a3b3c3d41b5bbc814002e16c8fd";
        
        // Your upcoming flights with detailed schedule information.
        const myFlights = [
            { 
                flightNumber: 'AC3106', flightDate: '2025-08-09', airline: 'United Airlines', 
                departure: { iata: 'SFO', airport: 'San Francisco Int\'l', time: '11:47 PM' }, 
                arrival: { iata: 'YUL', airport: 'Montréal-Trudeau', time: '8:16 AM' } 
            },
            { 
                flightNumber: 'AC878',  flightDate: '2025-08-10', airline: 'Air Canada',
                departure: { iata: 'YUL', airport: 'Montréal-Trudeau', time: '7:30 PM' },
                arrival: { iata: 'TLS', airport: 'Toulouse-Blagnac', time: '8:25 AM' }
            },
            { 
                flightNumber: 'AC879',  flightDate: '2025-08-30', airline: 'Air Canada',
                departure: { iata: 'TLS', airport: 'Toulouse-Blagnac', time: '10:00 AM' },
                arrival: { iata: 'YUL', airport: 'Montréal-Trudeau', time: '11:40 AM' }
            },
            { 
                flightNumber: 'AC763',  flightDate: '2025-08-30', airline: 'Air Canada',
                departure: { iata: 'YUL', airport: 'Montréal-Trudeau', time: '4:45 PM' },
                arrival: { iata: 'SFO', airport: 'San Francisco Int\'l', time: '7:57 PM' }
            }
        ];

        // --- DOM Elements ---
        const flightsListContainer = document.getElementById('flights-list');

        // --- Core Functions ---
        async function fetchFlightData(flightIata, flightDate) {
            const originalApiUrl = `http://api.aviationstack.com/v1/flights?access_key=${apiKey}&flight_iata=${flightIata}`;
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(originalApiUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`CORS proxy request failed: ${response.status}`);
                
                const proxyData = await response.json();
                const apiData = JSON.parse(proxyData.contents);

                if (apiData.error) throw new Error(apiData.error.info || `API returned an error for ${flightIata}.`);
                if (apiData.data && apiData.data.length > 0) return apiData.data[0];
                
                throw new Error(`Live data for flight ${flightIata} not found.`);
            } catch (error) {
                console.error(`Error fetching ${flightIata}:`, error);
                return { error: true, flightIata, message: error.message };
            }
        }
        
        function createFlightCard(flight, statusInfo) {
            const isLiveData = statusInfo && !statusInfo.error;
            
            const flight_status = isLiveData ? statusInfo.flight_status : 'scheduled';
            const airlineName = isLiveData ? statusInfo.airline.name : flight.airline;
            const departure = isLiveData ? statusInfo.departure : flight.departure;
            const arrival = isLiveData ? statusInfo.arrival : flight.arrival;

            const formatTime = (dateString, timeZone) => {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: timeZone });
            };

            const getStatusClass = (status) => {
                const s = status || 'unknown';
                switch(s) {
                    case 'scheduled': return 'bg-blue-600';
                    case 'active': case 'en-route': return 'bg-indigo-600';
                    case 'landed': return 'bg-green-600';
                    case 'cancelled': return 'bg-red-600';
                    case 'delayed': return 'bg-yellow-500 text-black';
                    default: return 'bg-gray-600';
                }
            };
            
            let statusText;
            if (isLiveData) {
                statusText = (flight_status || 'Unknown').replace(/_/g, ' ');
            } else {
                // For future flights, show "Scheduled for [Date]"
                const d = new Date(flight.flightDate + 'T00:00:00');
                const formattedDate = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });
                statusText = `Scheduled for ${formattedDate}`;
            }
            
            const departureTime = isLiveData ? formatTime(departure.scheduled, departure.timezone) : departure.time;
            const arrivalTime = isLiveData ? formatTime(arrival.scheduled, arrival.timezone) : arrival.time;
            const departureGate = isLiveData ? statusInfo.departure.gate : 'N/A';
            const arrivalGate = isLiveData ? statusInfo.arrival.gate : 'N/A';

            return `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
                    <div class="p-4 ${getStatusClass(flight_status)} text-white">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-xs opacity-80">${airlineName}</p>
                                <p class="text-xl font-bold">${flight.flightNumber}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs opacity-80">Status</p>
                                <p class="text-xl font-bold ${!isLiveData ? '' : 'capitalize'}">${statusText}</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-5 gap-y-4">
                            <!-- Departure -->
                            <div>
                                <h3 class="text-base font-semibold text-gray-500 dark:text-gray-400">Departure</h3>
                                <p class="text-xl font-bold text-gray-900 dark:text-white">${departure.iata}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-300 truncate">${departure.airport}</p>
                                <div class="mt-2 text-xs space-y-1">
                                    <p><span class="font-medium text-gray-600 dark:text-gray-400">Time:</span> ${departureTime}</p>
                                    <p><span class="font-medium text-gray-600 dark:text-gray-400">Gate:</span> ${departureGate}</p>
                                </div>
                            </div>
                            <!-- Arrival -->
                            <div>
                                <h3 class="text-base font-semibold text-gray-500 dark:text-gray-400">Arrival</h3>
                                <p class="text-xl font-bold text-gray-900 dark:text-white">${arrival.iata}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-300 truncate">${arrival.airport}</p>
                                <div class="mt-2 text-xs space-y-1">
                                    <p><span class="font-medium text-gray-600 dark:text-gray-400">Time:</span> ${arrivalTime}</p>
                                    <p><span class="font-medium text-gray-600 dark:text-gray-400">Gate:</span> ${arrivalGate}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${!isLiveData ? `<div class="bg-gray-50 dark:bg-gray-700/50 px-5 py-2 text-[10px] text-center text-gray-500 dark:text-gray-400">Live tracking will begin on the day of departure.</div>` : ''}
                </div>
            `;
        }

        function createErrorCard(flight, errorData) {
            const scheduledCard = createFlightCard(flight, null); // Show scheduled info
            const errorHtml = `
                <div class="mt-[-8px] rounded-b-2xl bg-red-100 dark:bg-red-900/20 border-t-2 border-red-200 text-red-700 dark:text-red-300 p-2 text-[10px] text-center" role="alert">
                    <strong>Update Failed:</strong> ${errorData.message}
                </div>
            `;
            // Combine the scheduled card with an error message at the bottom
            return scheduledCard.replace('</div></div></div>', `</div></div></div>${errorHtml}`);
        }

        async function loadMyTrips() {
            flightsListContainer.innerHTML = '<div class="my-12 flex justify-center"><div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div></div>';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day for comparison

            const flightPromises = myFlights.map(async (flight) => {
                const flightDate = new Date(flight.flightDate + 'T00:00:00-08:00'); // Assume PST for date parsing
                flightDate.setHours(0, 0, 0, 0);

                if (flightDate.getTime() === today.getTime()) {
                    // Fetch live data only if the flight is today
                    const liveData = await fetchFlightData(flight.flightNumber, flight.flightDate);
                    if (liveData.error) {
                        return createErrorCard(flight, liveData);
                    }
                    return createFlightCard(flight, liveData);
                } else {
                    // For future or past flights, just show the scheduled info
                    return createFlightCard(flight, null);
                }
            });
            
            const flightCardsHtml = await Promise.all(flightPromises);
            flightsListContainer.innerHTML = flightCardsHtml.join('');
        }

        document.addEventListener('DOMContentLoaded', loadMyTrips);
    </script>
</body>
</html>
